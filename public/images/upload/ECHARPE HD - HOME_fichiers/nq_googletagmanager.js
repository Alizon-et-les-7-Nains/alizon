var gtmEvents = (function($) {

    /**
     * Boot public function
     */
    var boot = function() {};

    var processUpdate = false;

    /**
     * Events generated by data attributes
     */
    var gtmEvents = function() {

        $('[data-gtm-event]').on('click', function(e) {

            var event = {};
            $.each($(this).data(), function(k, v) {
                if (0 === k.indexOf('gtm')) {
                    event[(k.charAt(3).toLowerCase() + k.slice(4))] = v;
                }
            });
            if (!$.isEmptyObject(event)) {
                try {
                    window.dataLayer.push(event);
                } catch (error) {

                }
            }
        });
    };

    var pushDataLayerAddToCart = function ($meta, quantity) {
        if (!$meta.length) {
            return false;
        }

        var productName = $meta.data('gtm-name');
        var productCategory = $meta.data('gtm-category');
        var productCategoryId = $meta.data('gtm-category-id');
        var productPrice = Math.round($meta.data('gtm-price') * 100, 2) / 100;
        var productPriceWtTax = Math.round($meta.data('gtm-price-notax') * 100, 6) / 100;
        var productRating = $meta.data('gtm-product-rating')
        var productNbPhotos = $meta.data('gtm-product-photos');
        var eventOrigin = $meta.data('gtm-event-origin');
        var productId = $meta.data('gtm-id');

        var productQuantity = quantity;
        if ($('#quantity_wanted').length > 0) {
            productQuantity = parseInt($('#quantity_wanted').val());
        }

        if (productQuantity === false) {
            productQuantity = 1;
        }

        var variant = '';
        if ($meta.attr('gtm-variant') != undefined) {
            variant = $meta.data('gtm-variant');
        } else {
            $('.product-variants select option[selected="selected"], .product-variants input[type="radio"]:checked').each(function () {
                if (variant != '') {
                    variant += ' - ';
                }
                if ($(this).is(':checked')) {
                    var labelObj = $('.product-variants label[for="' + $(this).attr('name') + '_' + $(this).val() + '"] span');
                    if (labelObj.length > 0) {
                        variant += labelObj.text();
                    }
                } else {
                    variant += $(this).text();
                }
            });
        }

        var productLayer = {
            'name': productName,
            'id': productId,
            'price': productPrice,
            'price_tf': productPriceWtTax,
            'category': productCategory,
            'category_id': productCategoryId,
            'quantity': productQuantity,
            'product_rating': productRating,
            'product_nb_photos': productNbPhotos
        };

        if (variant != '') {
            productLayer.variant = variant;
        }

        var dataLayer = {
            'event': 'addToCart',
            'eventAction': 'Add to Cart',
            'eventCategory': 'Ecommerce',
            'eventLabel': productName,
            'ecommerce': {
                //'currencyCode': currencyCode,
                'add': {
                    'actionField': {
                        'list': eventOrigin
                    },
                    'products': [
                        productLayer
                        ]
                }
            }
        };

        try {
            window.dataLayer.push(dataLayer);
        } catch (error) {

        }

        // Update meta for JS update
        $meta.attr('data-gtm-quantity', productQuantity);
    };

    var pushDataLayerRemoveToCart = function($meta, newQuantity) {
        if (!$meta.length) {
            return false;
        }

        if (!$meta.length) {
            return false;
        }
        var productName = $meta.data('gtm-name');
        var productCategory = $meta.data('gtm-category');
        var productPrice = $meta.data('gtm-price');
        var productId = $meta.data('gtm-id');
        var productQuantity = newQuantity;
        var productVariant = $meta.data('gtm-variant');
        var productCategoryId = $meta.data('gtm-category-id');
        var productPriceWtTax = $meta.data('gtm-price-notax');
        var productRating = $meta.data('gtm-product-rating');
        var productNbPhotos = $meta.data('gtm-product-photos');
        var eventOrigin = $meta.data('gtm-event-origin');

        var dataLayer = {
            'event': 'removeFromCart',
            'eventCategory': 'Ecommerce',
            'eventAction': 'Remove From Cart',
            'eventLabel': productName,
            'ecommerce': {
                'actionField': {
                    'list': eventOrigin
                },
                'remove': {
                    'products': [{
                        'name': productName,
                        'id': productId,
                        'price': productPrice,
                        'price_tf': productPriceWtTax,
                        'category': productCategory,
                        'category_id': productCategoryId,
                        'quantity': productQuantity,
                        'product_rating': productRating,
                        'product_nb_photos': productNbPhotos
                    }]
                }
            }
        };

        if(productVariant !== undefined && productVariant !== '')
            dataLayer.ecommerce.remove.products[0]['variant'] = productVariant;

        try {
            window.dataLayer.push(dataLayer);
        } catch (error) {

        }

        // Update meta for JS update
        $meta.attr('data-gtm-quantity', productQuantity);
    };

    /**
     * Custom events to update in each project
     */
    var customEvents = function() {

        // Add to cart
        $(document).on('click', '.add-to-cart, button[data-button-action="add-to-cart"], #add_to_cart button, .ajax_add_to_cart_button', function() {

            var $meta = $(this).parents('li').find('.gtm-meta');

            if ($meta.length == 0) {

                $meta = $('.footer-container #gtm-meta-product');

                if ($meta.length == 0) {
                    return true;
                }
            }

            pushDataLayerAddToCart($meta, false)

        });

        // Update from cart
        $(document).on('click', 'a.cart_quantity_up, a.cart_quantity_down', function(e) {
            e.preventDefault();
            if (processUpdate) {
                processUpdate = false;
                return true;
            }

            e.stopPropagation();
            if ($(this).hasClass('cart_quantity_down'))
            {
                processUpdate = true;
                pushDataLayerRemoveToCart($(this).parents('tr.cart_item').find('.gtm-meta'), 1);
                //$(this).click();
            } else {
                processUpdate = true;
                pushDataLayerAddToCart($(this).parents('tr.cart_item').find('.gtm-meta'), 1);
                //$(this).click();
            }
        });

        // Update from cart with input field
        $(document).on('change', '.js-cart-line-product-quantity', function() {
            if ($(this).val() == 0) {
                pushDataLayerRemoveToCart($(this), $('.input-quantity').val());
            } else {
                var $meta = $(this).parents('tr.cart_item').find('.gtm-meta');
                if (parseInt($meta.data('gtm-quantity')) > parseInt($(this).val())) {
                    pushDataLayerRemoveToCart($(this).parents('tr.cart_item').find('.gtm-meta'), parseInt($meta.data('gtm-quantity')) - parseInt($(this).val()));
                } else if (parseInt($meta.data('gtm-quantity')) < parseInt($(this).val())) {
                    pushDataLayerAddToCart($(this).parents('tr.cart_item').find('.gtm-meta'), parseInt($(this).val()) - parseInt($meta.data('gtm-quantity')));
                }
            }
        });

        // Remove from cart
        $(document).on('click', '.remove-from-cart, .ajax_cart_block_remove_link, .cart_quantity_delete', function(e) {
            if (processUpdate) {
                processUpdate = false;
                return true;
            }

            var $meta = $(this).parents('tr.cart_item').find('.gtm-meta');
            if ($meta.length == 0) {
                $meta = $(this).parents('dt').find('.gtm-meta');
            }

            e.stopPropagation();
            processUpdate = true;
            pushDataLayerRemoveToCart($meta, $(this).parents('tr.cart_item').find('.cart_quantity_input').val());
            $(this).click();
        });

        // Delivery choice
        /*$(document).on('click', '.carrier-radio input[name^="delivery_option["]', function(e) {
            var carrierName = $(this).parents('.delivery-option').find('.carrier-name').text().trim();
            window.dataLayer.push({
                'event' : 'checkoutOptionLivraison',
                'eventCategory' : 'Ecommerce',
                'eventAction' : 'Checkout Option',
                'eventLabel' : 'Checkoutoptionlivraison',
                'ecommerce' : {
                    'checkout_option' : {
                        'actionField' : {
                            'step' : 3,
                            'option' : carrierName
                        }
                    }
                }
            });
        });


        // Payment choice
        $(document).on('click', 'input[name="payment-option"]', function(e) {
            var paymentName = $(this).parents('.payment-option').find('.payment-option-text').text().trim();
            window.dataLayer.push({
                'event' : 'checkoutOptionPaiement',
                'eventCategory' : 'Ecommerce',
                'eventAction' : 'Checkout Option',
                'eventLabel' : 'Checkoutoptionpayment',
                'ecommerce' : {
                    'checkout_option' : {
                        'actionField' : {
                            'step' : 4,
                            'option' : paymentName
                        }
                    }
                }
            });
        });*/

        // Click on Product from Listing
        $(document).on('click', '.product_list li a, .slick-slide .product-hover a, .product-miniature a.product-thumbnail', function(e) {
            if ($(this).hasClass('ajax_add_to_cart_button')) {
                return true;
            }
            e.preventDefault();

            var $self = $(this).parents('article');

            if ($self.length === 0) {
                $self = $(this).parents('li');

                if ($self.length === 0) {
                    return false;
                }
            }

            var linkProduct = $(this);
            var urlProduct = linkProduct.attr('href');
            var $meta = $self.find('.gtm-meta');

            if (!$meta.length) {
                window.location = urlProduct;
            }
            var productName = $meta.data('gtm-name');
            var productCategory = $meta.data('gtm-category');
            var productCategoryId = $meta.data('gtm-category-id');
            var productPrice = $meta.data('gtm-price');
            var productPriceWt = $meta.data('gtm-price-notax');
            var productId = $meta.data('gtm-id');
            var listType = $meta.data('gtm-list-type');
            var productPosition = $meta.data('gtm-position');

            var callbackFailed = true;
            try {
                window.dataLayer.push({
                    'event': 'productClick',
                    'eventAction': 'Clic',
                    'eventCategory': 'Ecommerce',
                    'eventLabel': productName,
                    'ecommerce': {
                        'click': {
                            'actionField': {'list': listType},
                            'products': [
                                {
                                    'name': productName,
                                    'id': productId,
                                    'price': productPrice,
                                    'price_tf': productPriceWt,
                                    'category': productCategory,
                                    'category_id': productCategoryId,
                                    'position': productPosition,
                                    'list': listType
                                }]
                        }
                    },
                    'eventCallback': function () {
                        callbackFailed = false;
                        window.location = urlProduct;
                    }
                });
            } catch(error) {
                window.location = urlProduct;
            }

            if (callbackFailed) {
                window.location = urlProduct;
            }
        });

        if (typeof(gtmSearchVariables) != 'undefined') {
            try {
                window.dataLayer.push(gtmSearchVariables);
            } catch (error) {

            }
        }

        pushProductImpressions('');

        // Criteo Search
        if (typeof(criteoTag) != 'undefined') {
            window.dataLayer.push(criteoTag);
        }
    };

    // Impressions Produits
    var pushProductImpressions = function(parentSelector) {
        var impressions = [];
        var productPositions = [];

        var metaSignature = '.gtm-meta[data-impression="true"]';
        if (parentSelector !== '') {
            if (typeof(parentSelector) !== 'object') {
                parentSelector = $(parentSelector);
            }

            var objMeta = parentSelector.find(metaSignature);
        } else {
            var objMeta = $(metaSignature);
        }

        objMeta.each(function () {
            $meta = $(this);
            if (!$meta.length) {
                window.location = urlProduct;
            }
            var productName = $meta.data('gtm-name');
            var productCategory = $meta.data('gtm-category');
            var productCategoryId = $meta.data('gtm-category-id');
            var productPrice = $meta.data('gtm-price');
            var productPriceWt = $meta.data('gtm-price-notax');
            var productId = $meta.data('gtm-id');
            var listType = $meta.data('gtm-list-type');
            var position = $meta.data('gtm-position');

            if (listType == ''
                && $meta.data('gtm-event-origin').length > 0) {
                listType = $meta.data('gtm-event-origin');
            }

            if (position.length === 0) {
                if (productPositions[listType] == undefined) {
                    productPositions[listType] = 1;
                } else {
                    productPositions[listType]++;
                }

                position = productPositions[listType];
            }

            try {
                impressions.push(
                    {
                        'currencyCode': currencyCode,
                        'name': productName,
                        'id': productId,
                        'price': productPrice,
                        'price_tf': productPriceWt,
                        'category': productCategory,
                        'category_id': productCategoryId,
                        'position': position,
                        'list': listType
                    }
                );
            } catch (error) {

            }
        });

        if (impressions.length) {
            try {
                window.dataLayer.push({
                    'event': 'productimpression',
                    'eventAction': 'impression',
                    'eventCategory': 'Ecommerce',
                    'eventLabel': uriGTM,
                    'ecommerce': {
                        'impressions': impressions
                    }
                });
            } catch (error) {

            }
        }
    };

    // DOM Ready
    $(document).ready(function() {
        gtmEvents();
        customEvents();
    });

    // Public methods
    return {
        'boot': boot,
        'pushProductImpressions' : pushProductImpressions
    };
})(jQuery);

(function ($) {
    $.each(['show', 'hide'], function (i, ev) {
        var el = $.fn[ev];
        $.fn[ev] = function () {
            this.trigger(ev);
            return el.apply(this, arguments);
        };
    });
})(jQuery);

